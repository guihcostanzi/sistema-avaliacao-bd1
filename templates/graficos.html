{% extends "base.html" %}

{% block title %}Gr√°ficos - {{ projeto.nome }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center py-4 border-bottom">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="/submissoes">Submiss√µes</a></li>
                <li class="breadcrumb-item"><a href="/submissoes/{{ projeto.id }}/historico">{{ projeto.nome }}</a></li>
                <li class="breadcrumb-item active">Gr√°ficos</li>
            </ol>
        </nav>
        <h1 class="h3 mb-1 text-gray-800">
            <i class="bi bi-graph-up me-2 text-primary"></i>Gr√°ficos - {{ projeto.nome }}
        </h1>
        <p class="text-muted mb-0">Gere gr√°ficos din√¢micos baseados nas submiss√µes ({{ total_submissoes }} submiss√µes)</p>
    </div>
</div>

<div class="row my-4">
    <!-- Painel de Configura√ß√£o -->
    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-gear me-1"></i>Configura√ß√£o do Gr√°fico
                </h6>
            </div>
            <div class="card-body">
                <form id="formGrafico">
                    <!-- Tipo de Gr√°fico -->
                    <div class="mb-3">
                        <label for="tipo_grafico" class="form-label">
                            <strong>Tipo de Gr√°fico</strong>
                        </label>
                        <select class="form-control" id="tipo_grafico" name="tipo_grafico" required>
                            <option value="">Selecione o tipo</option>
                            <option value="pie">üçï Pizza (1 pergunta)</option>
                            <option value="bar">üìä Barras (2 perguntas)</option>
                            <option value="line">üìà Linha (2 perguntas)</option>
                            <option value="scatter">üîµ Dispers√£o (1 pergunta)</option>
                        </select>
                    </div>

                    <!-- Pergunta X (Eixo X) -->
                    <div class="mb-3">
                        <label for="pergunta_x" class="form-label">
                            <strong>Eixo X</strong>
                        </label>
                        <select class="form-control" id="pergunta_x" name="pergunta_x" required>
                            <option value="">Selecione uma pergunta</option>
                            {% for pergunta in perguntas %}
                            <option value="{{ pergunta.id }}" data-tipo="{{ pergunta.tipo }}" data-modelo="{{ pergunta.modelo }}">
                                {{ pergunta.pergunta }} ({{ pergunta.tipo|title }}) - {{ pergunta.total_submissoes }} respostas
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Pergunta Y (Eixo Y) -->
                    <div class="mb-3" id="div_pergunta_y" style="display: none;">
                        <label for="pergunta_y" class="form-label">
                            <strong>Eixo Y</strong>
                        </label>
                        <select class="form-control" id="pergunta_y" name="pergunta_y">
                            <option value="">Selecione uma pergunta</option>
                            {% for pergunta in perguntas %}
                            <option value="{{ pergunta.id }}" data-tipo="{{ pergunta.tipo }}" data-modelo="{{ pergunta.modelo }}">
                                {{ pergunta.pergunta }} ({{ pergunta.tipo|title }}) - {{ pergunta.total_submissoes }} respostas
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Escolha da Agrega√ß√£o Y -->
                    <div class="mb-3" id="div_agregacao_y" style="display: none;">
                        <label for="agregacao_y" class="form-label">
                            <strong>Agrega√ß√£o Y</strong>
                            <span class="text-muted">(Como agrupar valores)</span>
                        </label>
                        <select class="form-control" id="agregacao_y" name="agregacao_y">
                            <option value="soma">Soma (para n√∫meros) / Contagem (para outros)</option>
                            <option value="contagem">Contagem de ocorr√™ncias</option>
                        </select>
                        <small class="form-text text-muted">
                            <strong>Soma:</strong> Se Y √© num√©rico, soma os valores. Ex: duas vendas de R$100 = R$200<br>
                            <strong>Contagem:</strong> Conta quantas vezes o valor aparece. Ex: duas vendas = 2
                        </small>
                    </div>

                    <!-- Alertas de Valida√ß√£o -->
                    <div id="alerta_validacao" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <span id="texto_validacao"></span>
                    </div>

                    <!-- Dicas por Tipo de Gr√°fico -->
                    <div id="dicas_grafico" class="alert alert-info" style="display: none;">
                        <i class="bi bi-lightbulb me-1"></i>
                        <span id="texto_dicas"></span>
                    </div>

                    <!-- Bot√µes -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="btn_gerar">
                            <i class="bi bi-graph-up me-1"></i>Gerar Gr√°fico
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btn_limpar">
                            <i class="bi bi-arrow-clockwise me-1"></i>Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Estat√≠sticas do Projeto -->
        <div class="card shadow mt-3">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-info">
                    <i class="bi bi-info-circle me-1"></i>Estat√≠sticas
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="text-primary">
                            <i class="bi bi-question-circle fs-3"></i>
                            <div class="fw-bold">{{ perguntas|length }}</div>
                            <small class="text-muted">Perguntas</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-success">
                            <i class="bi bi-clipboard-check fs-3"></i>
                            <div class="fw-bold">{{ total_submissoes }}</div>
                            <small class="text-muted">Submiss√µes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- √Årea do Gr√°fico -->
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-success">
                    <i class="bi bi-graph-up me-1"></i>Visualiza√ß√£o
                </h6>
            </div>
            <div class="card-body">
                <!-- Estado Inicial -->
                <div id="estado_inicial" class="text-center py-5">
                    <i class="bi bi-graph-up text-muted" style="font-size: 4rem;"></i>
                    <h5 class="text-muted mt-3">Configure um gr√°fico</h5>
                    <p class="text-muted">Selecione o tipo de gr√°fico e as perguntas para visualizar os dados</p>
                </div>

                <!-- Loading -->
                <div id="loading_grafico" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <h5 class="text-muted mt-3">Gerando gr√°fico...</h5>
                </div>

                <!-- √Årea do Gr√°fico -->
                <div id="area_grafico" style="display: none;">
                    <div id="grafico_container" style="height: 400px;"></div>
                </div>

                <!-- Erro -->
                <div id="erro_grafico" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <span id="texto_erro"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
let currentChart = null;

// Configura√ß√µes dos tipos de gr√°fico
const tiposGrafico = {
    'pie': {
        nome: 'Pizza',
        perguntas: 1,
        dica: 'Mostra a distribui√ß√£o de uma pergunta. Ideal para dados categ√≥ricos.',
        labelX: 'Pergunta para An√°lise'
    },
    'bar': {
        nome: 'Barras',
        perguntas: 2,
        dica: 'Compara valores entre categorias. X = categoria, Y = valor num√©rico ou contagem.',
        labelX: 'Categorias (Eixo X)',
        labelY: 'Valores (Eixo Y)'
    },
    'line': {
        nome: 'Linha',
        perguntas: 2,
        dica: 'Mostra tend√™ncia ao longo do tempo ou sequ√™ncia. Ideal quando X √© data.',
        labelX: 'Sequ√™ncia (Eixo X)',
        labelY: 'Valores (Eixo Y)'
    },
    'scatter': {
        nome: 'Dispers√£o',
        perguntas: 1,
        dica: 'Mostra distribui√ß√£o de valores ao longo do tempo. Ideal para dados num√©ricos.',
        labelX: 'Pergunta para An√°lise'
    }
};

// Event listeners
document.getElementById('tipo_grafico').addEventListener('change', function() {
    const tipo = this.value;
    atualizarInterface(tipo);
});

document.getElementById('pergunta_x').addEventListener('change', validarSelecao);
document.getElementById('pergunta_y').addEventListener('change', validarSelecao);

document.getElementById('formGrafico').addEventListener('submit', function(e) {
    e.preventDefault();
    gerarGrafico();
});

document.getElementById('btn_limpar').addEventListener('click', function() {
    document.getElementById('formGrafico').reset();
    atualizarInterface('');
    mostrarEstado('inicial');
});

function atualizarInterface(tipo) {
    const config = tiposGrafico[tipo];
    const divY = document.getElementById('div_pergunta_y');
    const divAgregacao = document.getElementById('div_agregacao_y');
    const labelX = document.getElementById('label_x_desc');
    const dicas = document.getElementById('dicas_grafico');
    const textoDicas = document.getElementById('texto_dicas');
    
    if (config) {
        // Mostrar/ocultar segunda pergunta
        if (config.perguntas === 2) {
            divY.style.display = 'block';
            divAgregacao.style.display = 'block';
            document.getElementById('pergunta_y').required = true;
        } else {
            divY.style.display = 'none';
            divAgregacao.style.display = 'none';
            document.getElementById('pergunta_y').required = false;
            document.getElementById('pergunta_y').value = '';
        }
        
        // Atualizar labels
        labelX.textContent = `(${config.labelX || 'Eixo X'})`;
        
        // Mostrar dicas
        textoDicas.textContent = config.dica;
        dicas.style.display = 'block';
    } else {
        divY.style.display = 'none';
        divAgregacao.style.display = 'none';
        dicas.style.display = 'none';
        document.getElementById('pergunta_y').required = false;
    }
    
    validarSelecao();
}

function validarSelecao() {
    const tipo = document.getElementById('tipo_grafico').value;
    const perguntaX = document.getElementById('pergunta_x');
    const perguntaY = document.getElementById('pergunta_y');
    const alerta = document.getElementById('alerta_validacao');
    const textoValidacao = document.getElementById('texto_validacao');
    
    let erro = null;
    let aviso = null;
    
    if (tipo && perguntaX.value) {
        const tipoX = perguntaX.selectedOptions[0]?.dataset.tipo;
        const tipoY = perguntaY.selectedOptions[0]?.dataset.tipo;
        
        if (tipo === 'bar' && perguntaY.value) {
            // Para barras, qualquer combina√ß√£o funciona com agrega√ß√£o
            if (tipoX === tipoY && tipoX === 'texto' && perguntaY.value === perguntaX.value) {
                erro = 'Para gr√°fico de barras, selecione perguntas diferentes quando ambas s√£o do mesmo tipo.';
            } else if (tipoY !== 'numero') {
                aviso = 'Dica: Com Y n√£o num√©rico, ser√° usado contagem. Para soma, escolha uma pergunta num√©rica no eixo Y.';
            }
        } else if (tipo === 'line' && perguntaY.value) {
            // Para linha, X idealmente deveria ser sequencial (data/n√∫mero)
            if (tipoX === 'texto' || tipoX === 'email' || tipoX === 'booleano') {
                aviso = 'Dica: Gr√°fico de linha funciona melhor quando X √© data ou n√∫mero para mostrar tend√™ncia.';
            }
        } else if (tipo === 'scatter') {
            // Dispers√£o √© mais flex√≠vel agora
            if (tipoX === 'booleano') {
                aviso = 'Dica: Gr√°fico de dispers√£o com dados booleanos pode ter visualiza√ß√£o limitada.';
            }
        } else if (tipo === 'pie') {
            // Pizza sempre funciona, mas dica para muitos valores √∫nicos
            if (tipoX === 'numero') {
                aviso = 'Dica: Gr√°fico de pizza com n√∫meros pode gerar muitas fatias. Considere agrupar os dados.';
            }
        }
    }
    
    if (erro) {
        textoValidacao.textContent = erro;
        alerta.className = 'alert alert-danger';
        alerta.style.display = 'block';
    } else if (aviso) {
        textoValidacao.textContent = aviso;
        alerta.className = 'alert alert-warning';
        alerta.style.display = 'block';
    } else {
        alerta.style.display = 'none';
    }
}

async function gerarGrafico() {
    const formData = new FormData(document.getElementById('formGrafico'));
    
    mostrarEstado('loading');
    
    try {
        const response = await fetch(`/graficos/{{ projeto.id }}/gerar`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            renderizarGrafico(data);
            mostrarEstado('grafico');
        } else {
            mostrarErro(data.error || 'Erro ao gerar gr√°fico');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarErro('Erro de conex√£o');
    }
}

function renderizarGrafico(config) {
    const container = document.getElementById('grafico_container');
    
    // Configura√ß√£o base do Plotly
    let data, layout;
    
    if (config.type === 'pie') {
        data = [{
            values: config.series.map(s => s.data),
            labels: config.series.map(s => s.name),
            type: 'pie',
            hole: 0.3,
            textinfo: 'label+percent',
            textposition: 'outside'
        }];
    } else if (config.type === 'bar') {
        data = config.series.map(serie => ({
            x: config.categories,
            y: serie.data,
            name: serie.name,
            type: 'bar'
        }));
    } else if (config.type === 'line') {
        data = config.series.map(serie => ({
            x: config.categories,
            y: serie.data,
            name: serie.name,
            type: 'scatter',
            mode: 'lines+markers'
        }));
    } else if (config.type === 'scatter') {
        data = config.series.map(serie => ({
            x: serie.data.map(d => d[0]),
            y: serie.data.map(d => d[1]),
            name: serie.name,
            type: 'scatter',
            mode: 'markers'
        }));
    }
    
    layout = {
        title: {
            text: config.title.text,
            font: { size: 16 }
        },
        margin: { t: 50, r: 50, b: 50, l: 50 },
        showlegend: config.type !== 'pie',
        responsive: true
    };
    
    // Configura√ß√£o responsiva
    const plotConfig = {
        responsive: true,
        displayModeBar: false,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
        displaylogo: false
    };
    
    Plotly.newPlot(container, data, layout, plotConfig);
    currentChart = { container, data, layout, config: plotConfig };
}

function mostrarEstado(estado) {
    const estados = ['inicial', 'loading', 'grafico', 'erro'];
    
    estados.forEach(e => {
        const elemento = document.getElementById(e === 'inicial' ? 'estado_inicial' : 
                                               e === 'loading' ? 'loading_grafico' :
                                               e === 'grafico' ? 'area_grafico' : 'erro_grafico');
        elemento.style.display = e === estado ? 'block' : 'none';
    });
}

function mostrarErro(mensagem) {
    document.getElementById('texto_erro').textContent = mensagem;
    mostrarEstado('erro');
}

function downloadChart(format) {
    if (currentChart) {
        Plotly.downloadImage(currentChart.container, {
            format: format,
            width: 1200,
            height: 600,
            filename: `grafico_{{ projeto.nome|replace(' ', '_') }}`
        });
    }
}

function resetZoom() {
    if (currentChart) {
        Plotly.relayout(currentChart.container, {
            'xaxis.autorange': true,
            'yaxis.autorange': true
        });
    }
}
</script>
{% endblock %}